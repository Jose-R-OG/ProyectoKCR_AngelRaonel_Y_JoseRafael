@page "/lista-servicios"
@attribute [Authorize(Roles = "Administrador, Cajero")]
@layout MainLayout
@rendermode InteractiveServer
@using KCR.Models
@using KCR.Services
@inject ServiciosService servicioService
@inject NavigationManager navigationManager
@inject ToastService toastService

<div class="card shadow">
    <div class="list-card">
        <h1 class="list-title">📋 LISTA DE SERVICIOS Y PRODUCTOS</h1>

        <Toasts class="p-3 toast-grande" AutoHide="true" Delay="4000" Placement="ToastsPlacement.TopRight" />

        <div class="top-toolbar">
            <div class="search-group">
                <label for="search-input">Búsqueda</label>
                <div class="search-input-container">
                    <input type="text"
                           id="search-input"
                           class="form-control"
                           placeholder="Buscar por nombre o ID..."
                           @bind-value="FiltroNombre"
                           @bind-value:event="oninput"
                           @onkeyup="FiltrarServicios" />
                    <span class="search-icon">🔍</span>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-action btn-registrar" @onclick="IrARegistro">
                    <span class="icon">➕</span> Nuevo Servicio/Producto
                </button>
            </div>
        </div>

        @if (ServiciosListados == null)
        {
            <div class="text-center p-5">
                <p>Cargando servicios...</p>
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        }
        else if (!ServiciosListados.Any())
        {
            <div class="alert alert-info mt-3">
                No se encontraron servicios registrados o que coincidan con el filtro.
            </div>
        }
        else
        {
            <div class="table-container">
                <table class="modern-inventory-table">
                    <thead>
                        <tr>
                            <th>ID <span class="sort-icon"></span></th>
                            <th>Nombre <span class="sort-icon"></span></th>
                            <th>Precio <span class="sort-icon"></span></th>
                            <th>Tipo <span class="sort-icon"></span></th>
                            <th>Material Consumo</th>
                            <th>Consumo (Unidad)</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var servicio in ServiciosListados)
                        {
                            <tr>
                                <td data-label="ID" class="text-center"><strong>#@servicio.IdServicio</strong></td>
                                <td data-label="Nombre">@servicio.Nombre</td>
                                <td data-label="Precio" class="text-end">@servicio.Precio.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("es-DO"))</td>
                                <td data-label="Tipo">@servicio.TipoServicio</td>
                                <td data-label="Material Consumo">@(servicio.Materiales?.Nombre ?? "N/A")</td>
                                <td data-label="Consumo (Unidad)" class="text-center">@(servicio.ConsumoPorUnidad.HasValue? servicio.ConsumoPorUnidad.Value.ToString("N1") : "N/A")</td>
                                <td data-label="Estado" class="text-center">
                                    <span class="badge @(servicio.Activo ? "badge-activo" : "badge-inactivo")">
                                        @(servicio.Activo ? "Activo" : "Inactivo")
                                    </span>
                                </td>
                                <td data-label="Acciones" class="action-cell">
                                    <button class="btn-action btn-modificar btn-sm" @onclick="() => IrAEdicion(servicio.IdServicio)">
                                        Edit
                                    </button>
                                    <button class="btn-action btn-eliminar btn-sm" @onclick="() => CambiarEstado(servicio)">
                                        @(servicio.Activo ? "Desactivar" : "Activar")
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <tfoot>
                    <tr>
                        <td colspan="6" class="table-footer">
                            <button class="btn-volver" @onclick="Volver">
                                <i class="bi bi-arrow-left"></i> Volver
                            </button>
                        </td>
                    </tr>
                </tfoot>
            </div>

        }

    </div>
</div>
<img src="/Img-Vector/Union.svg" class="vector-corner" />

@code {
    private List<Servicios>? ServiciosOriginales;
    private List<Servicios>? ServiciosListados;
    private string FiltroNombre = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarServicios();
    }

    private async Task CargarServicios()
    {
        ServiciosOriginales = await servicioService.ListarTodoConMateriales();
        ServiciosListados = ServiciosOriginales;
    }

    private async Task FiltrarServicios()
    {
        await Task.Delay(200);

        if (ServiciosOriginales == null) return;

        if (string.IsNullOrWhiteSpace(FiltroNombre))
        {
            ServiciosListados = ServiciosOriginales;
        }
        else
        {
            var filtro = FiltroNombre.Trim();

            ServiciosListados = ServiciosOriginales
                .Where(s =>
                    s.Nombre.Contains(filtro, StringComparison.OrdinalIgnoreCase) ||
                    s.IdServicio.ToString().Equals(filtro)
                )
                .ToList();
        }
    }

    private void IrARegistro()
    {
        navigationManager.NavigateTo("/registro-servicio");
    }

    private void IrAEdicion(int idServicio)
    {
        navigationManager.NavigateTo($"/modificar-servicio/{idServicio}");
    }

    private async Task CambiarEstado(Servicios servicio)
    {
        servicio.Activo = !servicio.Activo;
        var exito = await servicioService.Guardar(servicio);

        if (exito)
        {
            toastService.ShowSuccess($"Servicio '{servicio.Nombre}' ha sido {(servicio.Activo ? "Activado" : "Desactivado")}.");
            StateHasChanged();
        }
        else
        {
            toastService.ShowError($"Error al cambiar el estado del servicio '{servicio.Nombre}'.");
            servicio.Activo = !servicio.Activo;
        }
    }

    private void Volver()
    {
        navigationManager.NavigateTo("/");
    }
}