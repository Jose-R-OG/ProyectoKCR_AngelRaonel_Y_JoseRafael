@page "/lista-materiales"
@attribute [Authorize(Roles = "Administrador")]

@using KCR.Models
@using KCR.Services
@using System.Linq.Expressions
@layout MainLayout
@inject NavigationManager navigationManager
@inject MaterialesService materialesService
@inject ToastService toastService
@rendermode InteractiveServer

<div class="list-card lista-materiales-page">
    <div class="content">

        <h1 class="list-title">INVENTARIO DE MATERIALES</h1>

        <Toasts class="p-3 toast-grande" AutoHide="true" Delay="4000" Placement="ToastsPlacement.TopRight" />

        <div class="top-toolbar">

            <div class="search-group">
                <label for="search-input">Búsqueda</label>
                <div class="search-input-container">
                    <input type="text" id="search-input" class="form-control"
                           placeholder="Buscar por nombre o ID..."
                           @bind="terminoBusqueda"
                           @oninput="AplicarFiltroYOrdenamiento" />
                    <span class="search-icon">🔍</span>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-action btn-registrar" @onclick="CrearNuevoMaterial">
                    <span class="icon">➕</span> Nuevo Material
                </button>
            </div>
        </div>

        <div class="table-container">

            @if (isLoading)
            {
                <p class="loading-message">Cargando inventario de materiales...</p>
            }
            else if (!MaterialesFiltrados.Any())
            {
                <p class="no-results-message">No se encontraron materiales. Intente ajustar la búsqueda o registre uno nuevo.</p>
            }
            else
            {
                <table class="modern-inventory-table">
                    <thead>
                        <tr>
                            <th @onclick='() => OrdenarPor("IdMaterial")'>ID <span class="sort-icon">@(ColumnaOrdenamiento == "IdMaterial" ? (EsAscendente ? "Up" : "Down") : "")</span></th>
                            <th @onclick='() => OrdenarPor("Nombre")'>Nombre <span class="sort-icon">@(ColumnaOrdenamiento == "Nombre" ? (EsAscendente ? "Up" : "Down") : "")</span></th>
                            <th @onclick='() => OrdenarPor("Existencia")'>Existencia <span class="sort-icon">@(ColumnaOrdenamiento == "Existencia" ? (EsAscendente ? "Up" : "Down") : "")</span></th>
                            <th @onclick='() => OrdenarPor("PrecioUnitario")'>Precio <span class="sort-icon">@(ColumnaOrdenamiento == "PrecioUnitario" ? (EsAscendente ? "Up" : "Down") : "")</span></th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var material in MaterialesFiltrados)
                        {
                            <tr>
                                <td data-label="ID" class="text-center"><strong>#@material.IdMaterial</strong></td>
                                <td data-label="Nombre">@material.Nombre</td>
                                <td data-label="Existencia" class="text-center">@material.Existencia</td>
                                <td data-label="Precio" class="text-end">@material.PrecioUnitario.ToString("C")</td>
                                <td data-label="Estado" class="text-center">
                                    <span class="badge @(material.Activo ? "badge-activo" : "badge-inactivo")">
                                        @(material.Activo ? "Activo" : "Inactivo")
                                    </span>
                                </td>
                                <td data-label="Acciones" class="action-cell">
                                    <button class="btn-action btn-modificar btn-sm"
                                            @onclick="() => ModificarMaterial(material.IdMaterial)">
                                        Edit
                                    </button>
                                    <button class="btn-action @(material.Activo ? "btn-eliminar" : "btn-activar") btn-sm"
                                            @onclick="() => CambiarEstado(material.IdMaterial, !material.Activo)">
                                        @(material.Activo ? "Desactivar" : "Activar")
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                    
                </table>
            }
        </div>
        
    </div>
</div>
<tfoot>
    <tr>
        <td colspan="6" class="table-footer">
            <button class="btn-volver" @onclick="Volver">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
        </td>
    </tr>
</tfoot>

@code {
    private List<Materiales> MaterialesOriginales { get; set; } = new();
    private List<Materiales> MaterialesFiltrados { get; set; } = new();
    private string terminoBusqueda = string.Empty;
    private bool isLoading = true;

    private string ColumnaOrdenamiento = "IdMaterial";
    private bool EsAscendente = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarMateriales();
    }

    private async Task CargarMateriales()
    {
        isLoading = true;
        try
        {
            MaterialesOriginales = await materialesService.Listar(m => true);
            AplicarFiltroYOrdenamiento();
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error al cargar materiales: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AplicarFiltroYOrdenamiento()
    {
        var query = MaterialesOriginales.AsEnumerable();
        var textoBusqueda = terminoBusqueda.Trim().ToLower();

        if (!string.IsNullOrWhiteSpace(textoBusqueda))
        {
            query = query.Where(m =>
                m.Nombre.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) ||
                m.IdMaterial.ToString().Equals(textoBusqueda)
            );
        }

        query = ColumnaOrdenamiento switch
        {
            "Nombre" => EsAscendente ? query.OrderBy(m => m.Nombre) : query.OrderByDescending(m => m.Nombre),
            "Existencia" => EsAscendente ? query.OrderBy(m => m.Existencia) : query.OrderByDescending(m => m.Existencia),
            "PrecioUnitario" => EsAscendente ? query.OrderBy(m => m.PrecioUnitario) : query.OrderByDescending(m => m.PrecioUnitario),
            "IdMaterial" or _ => EsAscendente ? query.OrderBy(m => m.IdMaterial) : query.OrderByDescending(m => m.IdMaterial),
        };

        MaterialesFiltrados = query.ToList();
        StateHasChanged();
    }

    private void OrdenarPor(string columna)
    {
        if (ColumnaOrdenamiento == columna)
        {
            EsAscendente = !EsAscendente;
        }
        else
        {
            ColumnaOrdenamiento = columna;
            EsAscendente = true;
        }
        AplicarFiltroYOrdenamiento();
    }

    private void CrearNuevoMaterial()
    {
        navigationManager.NavigateTo("/registro-material");
    }

    private void ModificarMaterial(int id)
    {
        navigationManager.NavigateTo($"/modificar-material/{id}");
    }

    private async Task CambiarEstado(int idMaterial, bool nuevoEstado)
    {
        try
        {
            var material = MaterialesOriginales.FirstOrDefault(m => m.IdMaterial == idMaterial);
            if (material == null)
            {
                toastService.ShowError("Material no encontrado.");
                return;
            }

            material.Activo = nuevoEstado;

            var success = await materialesService.Guardar(material);

            if (success)
            {
                toastService.ShowSuccess($"Material {material.Nombre} {(nuevoEstado ? "activado" : "desactivado")} correctamente.");
                await CargarMateriales();
            }
            else
            {
                toastService.ShowError("Error al cambiar el estado.");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error: {ex.Message}");
        }
    }

    private void Volver()
    {
        navigationManager.NavigateTo("/");
    }
}